## 索引与算法

### InnoDB存储引擎索引概述

&emsp;InnoDB存储引擎支持以下几种常见的索引：

+ B+树索引
+ 全文索引
+ 哈希索引

&emsp;InnoDB存储引擎支持的哈希索引是自适应的，InnoDB存储引擎会根据表的使用情况自动位表生成哈希索引，不能人为干预是否存在一张表中生成哈希索引。

&emsp;B+树索引就是传统意义上的索引，这是目前关系数据库系统中查找最为常用和最为有效的索引。B+树索引的构造类似于二叉树，根据键值（Key Value）快速找到数据。

> **注意**  B+树种的B不是代表二叉（binary）,而是代表平衡（balance），因为B+树是从最早的平衡二叉树演化而来，但是B+树不是一个二叉树。

&emsp;并且，B+树索引并不能找到一个给定键值的具体行。B+树索引能找到的只是被查找数据行所在的页。然后数据库通过把页读入到内存，再在内存中进行查找，最后得到要查找的数据。

### B+树索引

&emsp;B+树索引的本质就是B+树在数据库中的实现。但是B+索引在数据库中有一个特点是高扇出性，因此在数据库中，B+树的高度一般都在2~4层，也就是说查找某一键值的行记录时最多只需要2到4次IO。

&emsp;数据库中的B+树索引可以分为聚集索引（clustered index）和辅助索引（secondary index）。但是不管是聚集索引还是辅助的索引，其内部都是B+树的，即高度平衡的，叶子节点存放着所有的数据。聚集索引与辅助索引不同的是，叶子节点存放的是否是一整行的信息。

#### 聚集索引

&emsp;聚集索引（clustered index）就是按照每张表的主键构造一棵B+树，同时叶子节点中存放的即为整张表的行记录数据，也将聚集索引的叶子节点称为数据页。聚集索引（clustered index）就是按照每张表的主键构造一棵B+树，同时叶子节点中存放的即为整张表的行记录行为，也将聚集索引的叶子节点称为数据页。

&emsp;由于实际的数据页只能按照一棵B+树进行排序，因此每张表只能拥有一个聚集索引。在大多数情况下，查询优化器倾向于采用聚集索引。因为聚集索引能够在B+树索引的叶子节点上直接找到数据。此外，由于定义了数据的逻辑顺序，聚集索引能够特别块地访问针对范围值的查询。

&emsp;聚集索引的存储并不是物理上连续的，而是逻辑上连续的。这其中有两点：一是前面说过的页通过双向链表链接，页按照主键的顺序排序；另一点是每个页中的记录也是通过双向链表进行维护，物理存储上可以同样不按照主键存储。

&emsp;聚集索引的另一个好处是，它对于主键的排序查找和范围查找速度非常快。叶子节点的数据就是用户所要查询的数据。

&emsp;另一个是范围查询（range query），即如果要查找主键某一范围内的数据，通过叶子节点的上层中间节点就可以得到页的范围，之后直接读取数据页即可。

#### 辅助索引

&emsp;对于辅助索引（Secondary Index，也称非聚集索引），叶子节点并不包含行记录的全部数据。叶子节点除了包含键值以外，每个叶子节点的索引行中还包含了一个书签（bookmark）。该书签用来告诉InnoDB存储引擎哪里可以找到与索引相对应的行数据。由于InnoDB存储引擎表是索引组织表，因此InnoDB存储引擎的辅助索引的书签就是相应行数据的聚集索引键。

&emsp;辅助索引的存在并不影响数据在聚集索引中的组织，因此每张表上可以有多个辅助索引。当通过辅助索引来寻找数据时，InnoDB存储引擎会遍历辅助索引并通过叶级别的指针获得指向主键索引的主键，然后再通过主键索引来找到一个完整的行记录。

### B+树的应用

#### 联合索引

&emsp;联合索引是指对表上的多个列进行索引。

&emsp;那么何时需要使用联合索引呢？从本质上来说，联合索引也是一棵B+树，不同的是联合索引的键值的数量不是1，而是大于等于2。键值都是排序的，通过叶子节点可以逻辑上顺序地读出所有数据。

&emsp;联合索引的第二个好处是已经对第二个键值进行了排序处理

#### 覆盖索引

&emsp;InnoDB存储引擎支持覆盖索引（covering index，或称索引覆盖），即从辅助索引中就可以得到查询的记录，而不需要查询聚集索引中的记录。使用覆盖索引的一个好处是辅助索引不包含整行记录的所有信息，故其大小要远小于聚集索引，因此可以减少大量的IO操作。

### 哈希算法

#### InnoDB存储引擎中的哈希算法

&emsp;InnoDB存储引擎使用哈希算法来对字典进行查找，其冲突机制采用链表方式，哈徐函数采用除数散列方式。对于缓冲页的哈希表来说，在缓冲池中的Page页都有一个chain指针，它指向相同哈希函数值的页。而对于除法散列，m的取值为略大于2倍的缓冲池页数量的质数。

&emsp;InnoDB存储引擎的表空间都有一个space_id，用户所要查询的应该是某个表空间的某个连续16KB的页，即偏移量offset。InnoDB存储引擎将space_id左移20位，然后加上这个space_id和offset，即关键字K=space_id << 20 + space_id + offset，然后通过出发散列到各个槽中去。

#### 自适应哈希索引

&emsp;自适应哈希缩影经哈希函数映射到一个哈希表中，因此对于字典类型的查找非常快速，但是对于范围查找就无能为力了。

### 全文检索

#### 概述

&emsp;全文检索（Full-Text Search）是将存储于数据库中的整本书或整篇文章中的任意内容信息查找出来的技术。它可以根据需要获得全文中有关章、节、段、句、词等信息，也可以进行各种统计和分析。

#### 倒排索引

&emsp;全文检索通常使用倒排索引（inverted index）来实现。倒排索引同B+树索引一样，也是一种索引结构。它在辅助表（auxiliary table）中存储了单词与单词自身在一个或多个文档中所在位置之间的映射。这通常利用关联数组实现，其拥有两种表现形式：

+ inverted file index，其表现形式为{单词，单词所在文档的ID}
+ full inverted index, 其表现形式为{单词，（单词所在文档的ID，在具体文档中的位置）}

#### InnoDB全文检索

&emsp;InnoDB存储引擎从1.2x版本开始支持全文检索的技术，其采用full inverted index的方式。在InnoDB存储引擎中，将（DoucumentID，Position）视为一个“ilist”。因此，在全文检索的表中，有两个列，一个word字段，另一个是ilist字段，并且在word字段上有设有索引。



















